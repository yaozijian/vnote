# 类型布局

参考 [https://doc.rust-lang.org/reference/type-layout.html](https://doc.rust-lang.org/reference/type-layout.html)

[TOC]

# 1 概述

* 对齐
  * 类型的起始地址必须是对齐字节数`n`的整数倍
  * 对齐字节数`n`必须是2的幂：1,2,4,8……
  * 用`std::mem::align_of_val()`获取值的对齐字节数
* 大小
  * 大小总是对齐字节数的整数倍
  * 用`std::mem::size_of_val()`获取值的大小
* 类型对齐和大小
 * 用`std::mem::align_of()`获取固定大小类型对齐字节数
 * 用`std::mem::size_of()`获取固定大小类型的大小

# 2 各种类型的布局
## 2.1 原始类型

* 原始类型的对齐字节数是平台相关的，但多数原始类型对齐到其大小
* 然而，在`x86`平台中，`u64`和`f64`仅对齐到4字节（但是大小为8字节）

## 2.2 指针和引用

* 指针和引用的布局相同；可变性不影响布局
* 指向固定大小类型的指针，与`usize`有相同的大小和对齐
* 指向不确定大小类型的指针，是固定大小的，其大小和对齐，**至少等于**指向固定大小类型的指针（但不应该依赖于这一点：当前指向不确定大小类型的指针，实际上是胖指针，大小为`usize`的2倍，对齐与`usize`相同）

## 2.3 数组

* 数组`[T;n]`的大小为`std::mem::size_of::<T>()*n`，对齐等于`std::mem::align_of::<T>()`

## 2.4 切片

* 切片类型`[T]`的大小和对齐等于相应的数组类型

## 2.5 `str`

* `str`的大小和对齐等于`[u8]`

## 2.6 元组

* `()`大小为0，对齐为1字节
*其他元组类型没有布局保证

## 2.7 特性对象

* 特性对象的大小和对齐等于相应的具体类型的大小和对齐
* 注意：上一点仅对于原始特性对象，不包括`&Trait`和`Box<Trait>`之类的、指向特性对象的指针

## 2.8 闭包

* 闭包类型没有布局保证

# 3 表示

* 所有用户自定义复合类型（结构体、枚举、联合体）都由**表示（representation ）**定义其内存布局
* 可能的表示类型：默认、C、原始(primitive)、压缩(packed)
* 一种类型可以有多种表示
* 泛型不影响表示：`Foo<Bar>`和`Foo<Baz>`的表示相同
* 类型的表示不影响内部字段的表示：一个表示为`C`的结构体，可以含有一个默认表示的字段
* 可以用`#[repr(表示名称)]`来设置类型的表示

```rust
#[repr(C)]
struct ThreeInts {
    first: i16,
    second: i8,
    third: i32
}
```

## 3.1 默认表示

* 通常的、没有用`#[repr(..)]`设置表示的类型，使用默认表示
* 默认表示也被非正式地称作`rust`表示
* 默认表示没有数据内存布局保证

## 3.2 `C`表示

两个目的：

1. 与`C`语言交互
2. 确定地执行与内存布局相关的操作，如重新解释为另一种类型

### 3.2.1 `#[repr(C)]`结构体

* 各个字段的偏移：从偏移0开始，对每个字段
 * 确定其大小和对齐。原始类型的大小和对齐见本文2.1节
 * 如果当前偏移不是字段对齐的整数倍，则在前面填充一些字节
 * 然后将偏移加上字段大小
* 结构体对齐
 * 结构体对齐等于其中字段的最大对齐
 * 如果在最后一个字段后，偏移不是结构体对齐的整数倍，则在最后一个字段后填充一些字节

### 3.2.2 `#[repr(C)]`联合体

* 对齐：对于字段的最大对齐
* 大小：等于最大字段大小，上取整到对齐的整数倍，必要时填充一些字节
* 最大对齐和最大字段大小可能不是来自同一个字段

### 3.2.3 `#[repr(C)]`枚举

## 3.3 原始表示

* 原始表示仅能应用于枚举类型
* 原始表示的名称，就是原始整数类型的名称：`u8`、`u16`、`usize`、`i8`、`i16`、`isize`等

## 3.4 `align`表示

* 可将`#[repr(align(x))]`应用于结构体和联合体，以增加类型的对齐

## 3.5 `packed`表示

* 移除填充字节，强制对齐为1

## 3.5 `transparent`表示

* 仅能用于含有单个非零大小字段，以及任意多个零大小字段的结构体
* 结构体的表示与单个非零字段类型的表示完全相同
